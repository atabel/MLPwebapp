var App=(function(a,b){a.App.init({name:"Mira la Prima",version:"0.1",resources:{sections:["country.html","uploadprima.html","about.html"]}});a.ready(function(){if(Device.isFree()){$$("#section-prima-country .country-view-mode").hide();$$("#section-prima-country footer").addClass("transparent-footer");$$("body").addClass("free-version")}});return{}})(LUNGO);App.Data=(function(f,c,d){var b=2;f.Data.Sql.init({name:"prima-db",version:"1.0",schema:[{name:"countries",drop:false,fields:{id:"INTEGER PRIMARY KEY",name:"TEXT",country_code:"TEXT",prima_value:"FLOAT",prima_delta:"FLOAT",prima_percent:"FLOAT",last_update:"DATETIME"}},{name:"favourites",drop:false,fields:{id:"INTEGER PRIMARY KEY",country_code:"TEXT"}}]});var j=function(n){var m=new Date(n);m.setMinutes(m.getMinutes()+b);return(m<new Date())};var h=function(n,o,m){f.Data.Sql.select("countries",{country_code:n},function(q){if(q&&q.length>0&&!m&&!j(q[0].last_update)){f.Data.Cache.set("current_country",q[0]);o(q[0])}else{var r=c.Services.loadPrimaValue(n,function(s){if(s){e(s);f.Data.Cache.set("current_country",s);o(s)}else{f.Data.Cache.set("current_country",{country_code:n});o(s)}});var p=r.abort;r.abort=function(){if(q&&q.length>0){o(q[0])}p()}}})};var k=function(n,m){f.Data.Sql.select("countries",null,function(p){var q=_.min(p,function(s){return s.last_update});if(p&&p.length>0&&!m&&!j(q.last_update)){n(p)}else{var r=c.Services.getCountriesList(function(s){if(s){e(s);n(s)}else{if(p&&p.length>0){n(p)}}});var o=r.abort;r.abort=function(){if(p&&p.length>0){n(p)}o()}}})};var i=function(m,o,n){n=_.pick(n,"name","prima_value","prima_percent","prima_delta","country_code");f.Data.Sql.select(m,o,function(p){if(p&&p.length>0){f.Data.Sql.update(m,n,o)}else{f.Data.Sql.insert(m,n)}})};var e=function(n){var o=(new Date()).valueOf();if(_.isArray(n)){var m,p;for(p=0,m=n.length;p<m;p++){var q=n[p];q.last_update=o;i("countries",{country_code:q.country_code},q)}}else{n.last_update=o;i("countries",{country_code:n.country_code},n)}};var l=function(m){f.Data.Sql.select("favourites",{country_code:m},function(n){if(!n||n.length==0){f.Data.Sql.insert("favourites",{country_code:m})}})};var a=function(n,m){f.Data.Sql.select("favourites",null,function(s){var r=[];var p=0;var o=s.length;if(o==0){n([])}else{for(var q=0;q<o;q++){country_code=s[q].country_code;h(country_code,function(t){r.push(t);p++;if(p==o){n(r)}},m)}}})};var g=function(m){f.Data.Sql.drop("favourites",{country_code:m})};return{getCountry:h,saveCountries:e,addFavourite:l,removeFavourite:g,getFavourites:a,getCountriesList:k}})(LUNGO,App);Device=window.Device=window.Device||{};Device.Const={IS_FREE:false,};Device.isFree=Device.isFree||function(){return Device.Const.IS_FREE};Device.isOnline=Device.isOnline||function(){return true};Device.HWexit=Device.exit;Device.exit=function(){console.log("user wants to EXIT");if(_.isFunction(Device.HWexit)){lng.Data.Sql.execute("DROP TABLE IF EXISTS countries");Device.HWexit();console.log("EXIT")}else{window.location.href="http://www.example.com/#EXIT"}};App.Events=(function(a,d,c){UNIMPLEMENTED_FEATURES=[];var b=function(){console.log("*****LUNGO INIT DONE*****");a.Data.Sql.select("favourites",null,function(e){a.View.Element.count("#favourites-tab-btn",e.length)});d.Data.getCountriesList(d.View.viewCountriesList,true)};a.dom("#all-primas").on("pulldownrefresh",function(){d.Data.getCountriesList(function(e){d.View.viewCountriesList(e);pdrscroll.refresh("all-primas")},true)});a.dom("#article-prima-value").on("pulldownrefresh",function(){var e=a.Data.Cache.get("current-country");d.Data.getCountry(e.country_code,function(f){d.View.viewCountry(f);pdrscroll.refresh("article-prima-value")},true)});a.dom("#favourite-primas").on("pulldownrefresh",function(){d.Data.getFavourites(function(e){d.View.viewFavourites(e);pdrscroll.refresh("favourite-primas")},true)});a.dom("#section-main li a[data-country]").tap(function(f){a.dom("#article-prima-value").html("");a.dom("#article-prima-value").style("background-image","none");a.dom("#article-prima-value").style("background-color","gray");var g=a.dom(this).data("country");var e=$$(this).children(".country-name").text();a.dom("#section-prima-country header .title").text("Prima de "+e);d.Data.getCountry(g,d.View.viewCountry)});a.dom("#change-picture").tap(function(e){d.PhotoManager.getPhoto(null,d.View.changePicture)});a.dom("#add-to-fav-btn").tap(function(e){var f=a.Data.Cache.get("current_country");a.Data.Sql.select("favourites",{country_code:f.country_code},function(g){if(g&&g.length>0){d.Data.removeFavourite(f.country_code);a.Sugar.Growl.notify("Favoritos","País quitado de favoritos","star","info",2);a.dom("#add-to-fav-btn").html("<span class='icon star'></span>Añadir a Favoritos")}else{d.Data.addFavourite(f.country_code);a.Sugar.Growl.notify("Favoritos","País añadido a favoritos","star","info",2);a.dom("#add-to-fav-btn").html("<span class='icon star'></span>Quitar de Favoritos")}console.log("geting favourites to refresh");setTimeout(function(){d.Data.getFavourites(d.View.viewFavourites)},600);a.Router.aside("section-prima-country","menu-prima-country")})});a.dom("#article-prima-value .prima").tap(function(e){if(!Device.isFree()){var g=a.dom("#article-prima-value .prima");var f=g.hasClass("minified");if(f){g.removeClass("minified")}else{g.addClass("minified")}}});a.dom(document).on("backbutton",function(e){var f=a.Router.History.current();if(f=="#section-main"){var g=a.dom("#menu-main").hasClass("current");if(g){a.Router.aside("section-main","menu-main")}else{Device.exit()}}else{var g=a.dom("#menu-prima-country").hasClass("current");if(g){a.Router.aside("section-prima-country","menu-prima-country")}else{a.Router.back()}}});a.dom(document).on("menubutton",function(e){var f=a.Router.History.current();if(f=="#section-prima-country"){a.Router.aside("section-prima-country","menu-prima-country")}else{if(f=="#section-main"){a.Router.aside("section-main","menu-main")}}});a.dom("#favourite-primas").on(a.Constants.TRIGGER.LOAD,function(e){d.Data.getFavourites(d.View.viewFavourites)});a.dom("#share-your-prima-btn").tap(function(){a.Router.aside("section-prima-country","menu-prima-country")});a.dom("#share-your-prima2-btn").tap(function(){a.Router.aside("section-main","menu-main")});a.dom("#upload-url-btn").tap(function(){var e=a.dom("#url-input").val();if(e&&d.Utils.Valid.isURL(e)){d.Services.uploadPrimaPicture(e)}else{a.Sugar.Growl.show("Introduce una URL válida","","warning",false,3)}});a.dom("#img-cover-btn").tap(function(e){e.preventDefault();var g=$$(this).children("span");var f=g.hasClass("icon-fullscreen");g.removeClass("icon-fullscreen").removeClass("icon-fullscreen-exit");if(f){a.dom("#article-prima-value").style("background-size","cover");a.dom("#article-prima-value").style("-webkit-background-size","cover");g.addClass("icon-fullscreen-exit")}else{a.dom("#article-prima-value").style("background-size","contain");a.dom("#article-prima-value").style("-webkit-background-size","contain");g.addClass("icon-fullscreen")}});a.dom("#num-view-btn").tap(function(){d.View.setCountryView("numeric")});a.dom("#chart-view-btn").tap(function(){var e=a.Data.Cache.get("current_country");d.Services.loadPrimaHistory(e.country_code,7,function(g){var f=$$("#prima-chart");f.hide().text(g.join());f.peity("line");f.show()});d.View.setCountryView("chart")});a.dom(UNIMPLEMENTED_FEATURES.join(", ")).tap(function(){var e=[{name:"Aceptar",icon:"info",color:"blue",callback:function(){a.Sugar.Growl.hide()}}];a.Sugar.Growl.option("Esta opción no está disponible aun",e)});a.ready(function(){b()});return{}})(LUNGO,App);App.PhotoManager=(function(i,c,d){var g="current_photo";var e=[];var k=[];var b=function(o){if(!_.isArray(o)){o=[o]}_.each(o,function(q){f(q)})};var h=function(p,r,q){console.log("PHOTO REQUEST: ",p,"recur_times:",q);console.log("_photoList:",k);q=q||0;var o=_.filter(k,function(s){return s.viewed==false});if(p){console.log("filtering by country code");o=_.filter(o,function(s){return s.country_code==p})}console.log("_photoList_filtered:",o);if(o.length==0){if(q>2){console.log("recurtimes exceded",q,k.length);j();r(a(k))}else{console.log("get photos from server");c.Services.loadPrimaPicture(p,function(s){console.log("photos to add:",s);b(s);console.log("photos added _photoList:",k);console.log("now recur...");h(p,r,q+1)})}}else{r(a(o))}};var l=function(o){return !!_.find(k,function(q){return q.photo_url==o.photo_url})};var f=function(o){if(!l(o)){o.viewed=false;o.loaded=false;o.img=n(o.photo_url,function(){o.loaded=true;console.log("loaded IMG:",o)});k.push(o)}};var j=function(){k=_.map(k,function(o){o.viewed=false;return o})};var n=function(p,q){var o=new Image();o.src=p;o.onload=q;return o};var a=function(p){var o=m(p);k=_.map(k,function(q){if(q.photo_url==o.photo_url){q.viewed=true;return q}else{return q}});i.Data.Cache.set(g,o);console.log("returned photo:",o);e.push(o);return o};var m=function(o){return o[Math.floor(Math.random()*o.length)]};return{addPhotos:b,getPhoto:h,has:l}})(LUNGO,App);App.Services=(function(k,d,e){var o="http://miralaprima.herokuapp.com/GetPrima";var m="http://miralaprima.herokuapp.com/GetMoza";var b="http://miralaprima.herokuapp.com/SetMoza";var a="http://miralaprima.herokuapp.com/GetHistory";var l=new Date(0);var g=1;var j=function(p){var q=function(){var s=_.toArray(arguments);if(!Device.isOnline()){var t={abort:function(){}};var r=new Date();r.setMinutes(r.getMinutes()-g);if(r>l){k.Sugar.Growl.show("Error","Comprueba tu conexión","warning",false,2);l=new Date()}setTimeout(function(){t.abort()},100);return t}else{return p.apply(p,s)}};return q};var n=function(p){k.Sugar.Growl.show("Cargando","","loading",true,0);return $$.get(o,{callback:"?"},function(q){p(q);k.Sugar.Growl.hide()},"json")};var i=function(p,q){k.Sugar.Growl.show("Cargando","","loading",true,0);return $$.get(o,{country_code:p,callback:"?"},function(r){q(r);k.Sugar.Growl.hide()},"json")};var f=function(q,r){var p={callback:"?",limit:10,};q&&(p.country_code=q);return $$.get(m,p,r,"json")};var h=function(p,q){k.Sugar.Growl.show("Subiendo","","upload",true,0);return $$.get(b,{url_moza:p,callback:"?"},function(r){if(r&&r.result=="OK"){k.Sugar.Growl.notify("Prima subida","Si tu prima es aceptada pronto la verás por aquí ;-)","check","info",4)}else{k.Sugar.Growl.show("Error","Ocurrió un error subiendo la prima al servidor","warning",false,5)}},"json")};var c=function(q,p,r){p=p||7;k.Sugar.Growl.show("Cargando","","loading",true,0);return $$.get(a,{country_code:q,limit:p,callback:"?"},function(s){r(s);k.Sugar.Growl.hide()},"json")};$$.ajaxSettings.timeout=10000;$$.ajaxSettings.error=function(q,p){k.Sugar.Growl.show("Error","Falló la conexión con el servidor","warning",false,3)};return{getCountriesList:j(n),loadPrimaValue:j(i),loadPrimaPicture:f,uploadPrimaPicture:h,loadPrimaHistory:c}})(LUNGO,App);App.Utils=App.Utils||{};App.Utils.Valid=(function(a,c,b){var d=function(e){var f=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;return f.test(e)};return{isURL:d}})(LUNGO,App);App.View=(function(i,b,c){var k="#article-prima-value";var g=i.dom("#prima-tpl").text();i.View.Template.create("prima-tpl",g);var h=i.dom("#country-li-tpl").text();i.View.Template.create("country-li-tpl",h);var f=function(m){if(!m){i.dom(k).html("No hay datos de este país")}else{var o=m.prima_delta>=0;var l=m.prima_percent>=0;var n=_.clone(m);n.prima_delta=Math.abs(m.prima_delta);n.prima_percent=Math.abs(m.prima_percent);i.View.Template.render(k,"prima-tpl",n);i.dom(k+" .prima-delta").removeClass("positive-val").removeClass("negative-val").addClass(o?"positive-val":"negative-val").prepend("<span class='icon "+(o?"up":"down")+"'></span>");i.dom(k+" .prima-percent").removeClass("positive-val").removeClass("negative-val").addClass(l?"positive-val":"negative-val").prepend("<span class='icon "+(l?"up":"down")+"'></span>");b.PhotoManager.getPhoto(null,d);i.Data.Sql.select("favourites",{country_code:m.country_code},function(q){if(q&&q.length>0){i.dom("#add-to-fav-btn").html("<span class='icon star'></span>Quitar de Favoritos")}else{i.dom("#add-to-fav-btn").html("<span class='icon star'></span>Añadir a Favoritos")}});var p=m.country_code;$$("li[data-country-code='"+p+"'] .li-prima-value").text(m.prima_value);j("numeric")}};var d=function(m){var l=m.img.src;$$(k)[0].style.backgroundImage="url("+l+")";$$("#photo-provider-link").attr("href",m.provider)};var a=function(p){console.log("REFRESHING FAVOURITES: ",p);var o=i.dom("#favourites-tab-btn span.bubble.count");var n=o.length>0;var m=p.length;if(n){if(m<1){console.log("removing conunter");o.remove()}else{console.log("setting counter to ",m);o.text(""+m)}}else{if(m>0){console.log("initialicing counter to ",m);i.View.Element.count("#favourites-tab-btn",m)}}var l={el:"#favourite-primas",template:"country-li-tpl",data:p,order:{field:"prima_value",type:"desc"}};i.View.Template.List.create(l);pdrscroll.init("favourite-primas")};var e=function(m){var l={el:"#all-primas",template:"country-li-tpl",data:m,order:{field:"prima_value",type:"desc"}};i.View.Template.List.create(l);pdrscroll.init("all-primas")};var j=function(l){if(l==="numeric"){$$("#num-view-btn, #chart-view-btn").removeClass("current");$$("#num-view-btn").addClass("current");$$("#prima-chart").hide();$$("#prima-numbers").show()}else{if(l==="chart"){$$("#num-view-btn, #chart-view-btn").removeClass("current");$$("#chart-view-btn").addClass("current");$$("#prima-numbers").hide();$$("#prima-chart").show()}}};$$("#menu-prima-country").on("touchstart","a",function(l){$$(this).addClass("current")});$$("#menu-prima-country").on("mousedown","a",function(l){$$(this).addClass("current")});$$("#menu-prima-country").on("touchend","a",function(l){$$(this).removeClass("current")});$$("#menu-prima-country").on("mouseup","a",function(l){$$(this).removeClass("current")});$$("#menu-prima-country").on("mouseout","a",function(l){$$(this).removeClass("current")});$$(".list").on("touchstart","li.country-li",function(l){$$(this).addClass("active")});$$(".list").on("mousedown","li.country-li",function(l){$$(this).addClass("active")});$$(".list").on("touchend","li.country-li",function(l){$$(this).removeClass("active")});$$(".list").on("mouseup","li.country-li",function(l){$$(this).removeClass("active")});$$(".list").on("mouseout","li.country-li",function(l){$$(this).removeClass("active")});$$.fn.peity.defaults.line={colour:"rgba(5,184,226,0.3)",strokeColour:"rgba(0,98,172,0.8)",strokeWidth:3,delimiter:",",height:50,max:null,min:99999,width:200};return{viewCountry:f,changePicture:d,viewFavourites:a,viewCountriesList:e,setCountryView:j}})(LUNGO,App);